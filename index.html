<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Music Generator with Tone.js</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #217b77;
            --secondary-color: #e6af4b;
            --text-color: #333;
            --bg-color: #f9f7f2;
            --panel-bg: #fff;
            --border-color: #ddd;
            --border-radius: 8px;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        h3 {
            color: var(--primary-color);
            margin: 20px 0 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .control-panel, .output-panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        select[multiple] {
            height: 150px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-generate {
            background-color: #3498db;
        }
        
        .btn-generate:hover {
            background-color: #2980b9;
        }
        
        .btn-export {
            background-color: #27ae60;
        }
        
        .btn-export:hover {
            background-color: #219653;
        }
        
        .btn-stop {
            background-color: #e74c3c;
        }
        
        .btn-stop:hover {
            background-color: #c0392b;
        }
        
        .visualizer {
            width: 100%;
            height: 200px;
            background-color: #f5f5f5;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f5f5f5;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        audio {
            width: 100%;
            margin-top: 15px;
        }
        
        .instrument-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .instrument-option {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .instrument-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(33, 123, 119, 0.1);
        }
        
        .slider-container {
            margin-top: 10px;
        }
        
        .slider-container input {
            margin-top: 5px;
        }
        
        .slider-value {
            text-align: right;
            font-weight: bold;
        }

        #canvas-visualizer {
            width: 100%;
            height: 100%;
        }

        .eq-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .eq-band {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .eq-band label {
            width: 100px;
            font-size: 14px;
        }

        .eq-band input[type="range"] {
            flex: 1;
        }

        .eq-band span {
            width: 50px;
            text-align: right;
            font-size: 14px;
        }

        /* Style for the range inputs */
        input[type="range"] {
            -webkit-appearance: none;
            height: 5px;
            background: #217b77;
            border-radius: 5px;
            background-image: linear-gradient(#4CAF50, #4CAF50);
            background-repeat: no-repeat;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            -webkit-appearance: none;
            box-shadow: none;
            border: none;
            background: transparent;
        }

        .tabs {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-color);
            flex: 1;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 8px;
            background: white;
        }

        .track-item:hover {
            background: #f9f9f9;
        }

        .track-name {
            flex: 1;
            margin-right: 10px;
        }

        .track-controls {
            display: flex;
            gap: 5px;
        }

        .track-controls button {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Islamic Music Generator</h1>
            <p>Create beautiful Islamic-inspired background music with real instrument samples</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <h3><i class="fas fa-sliders-h"></i> Controls</h3>
                
                <div class="form-group">
                    <label for="music-length">Music Length:</label>
                    <select id="music-length">
                        <option value="30">30 seconds</option>
                        <option value="60" selected>60 seconds</option>
                        <option value="90">90 seconds</option>
                        <option value="120">2 minutes</option>
                        <option value="180">3 minutes</option>
                        <option value="300">5 minutes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Instruments:</label>
                    <div class="instrument-selection" id="instruments-container">
                        <div class="instrument-option selected" data-instrument="oud">
                            <i class="fas fa-guitar"></i> Oud
                        </div>
                        <div class="instrument-option selected" data-instrument="ney">
                            <i class="fas fa-wind"></i> Ney Flute
                        </div>
                        <div class="instrument-option" data-instrument="qanun">
                            <i class="fas fa-harp"></i> Qanun
                        </div>
                        <div class="instrument-option selected" data-instrument="daf">
                            <i class="fas fa-drum"></i> Daf
                        </div>
                        <div class="instrument-option" data-instrument="ambient">
                            <i class="fas fa-water"></i> Ambient
                        </div>
                        <div class="instrument-option" data-instrument="nature">
                            <i class="fas fa-tree"></i> Nature
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Other Music:</label>
                    <div class="tabs">
                        <div class="tab-header">
                            <button class="tab-btn active" data-tab="custom-tracks">Custom Tracks</button>
                            <button class="tab-btn" data-tab="asset-browser">Asset Browser</button>
                        </div>
                        <div class="tab-content">
                            <div class="tab-pane active" id="custom-tracks">
                                <div class="custom-tracks-list">
                                    <!-- Custom tracks will be listed here -->
                                </div>
                            </div>
                            <div class="tab-pane" id="asset-browser">
                                <div class="asset-browser-list">
                                    <!-- Asset browser content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="master-volume">Master Volume: <span id="volume-value">80%</span></label>
                    <div class="slider-container">
                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.8">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reverb-amount">Reverb: <span id="reverb-value">30%</span></label>
                    <div class="slider-container">
                        <input type="range" id="reverb-amount" min="0" max="1" step="0.01" value="0.3">
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Equalizer</h3>
                    <div class="eq-controls">
                        <div class="eq-band">
                            <label>Low (100Hz)</label>
                            <input type="range" id="eq-low" min="-12" max="12" value="0" step="1">
                            <span id="eq-low-value">0 dB</span>
                        </div>
                        <div class="eq-band">
                            <label>Mid (1kHz)</label>
                            <input type="range" id="eq-mid" min="-12" max="12" value="0" step="1">
                            <span id="eq-mid-value">0 dB</span>
                        </div>
                        <div class="eq-band">
                            <label>High (10kHz)</label>
                            <input type="range" id="eq-high" min="-12" max="12" value="0" step="1">
                            <span id="eq-high-value">0 dB</span>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="generate-btn" class="btn-generate">
                        <i class="fas fa-play"></i> Generate Music
                    </button>
                    <button id="stop-btn" class="btn-stop" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button id="export-btn" class="btn-export" disabled>
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="output-panel">
                <h3><i class="fas fa-wave-square"></i> Visualization</h3>
                
                <div class="status" id="status-message">
                    Ready to generate Islamic music. Click "Generate Music" to begin.
                </div>
                
                <div class="visualizer">
                    <canvas id="canvas-visualizer"></canvas>
                </div>
                
                <div class="form-group">
                    <audio id="output-audio" controls style="display: none;"></audio>
                </div>
                
                <div class="form-group">
                    <h3><i class="fas fa-bookmark"></i> Presets</h3>
                    <div class="button-group">
                        <button class="preset-btn" data-preset="meditation" style="background-color: #9b59b6;">
                            <i class="fas fa-pray"></i> Meditation
                        </button>
                        <button class="preset-btn" data-preset="relaxation" style="background-color: #2ecc71;">
                            <i class="fas fa-cloud"></i> Relaxation
                        </button>
                        <button class="preset-btn" data-preset="uplifting" style="background-color: #f39c12;">
                            <i class="fas fa-sun"></i> Uplifting
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        let recorder, playerBuffer;
        let isPlaying = false;
        let analyser, canvasContext, canvasVisualizer, dataArray;
        let animationFrame;
        let lowEQ, midEQ, highEQ;
        let customTracks = new Map();

        // Elements
        const generateBtn = document.getElementById('generate-btn');
        const stopBtn = document.getElementById('stop-btn');
        const exportBtn = document.getElementById('export-btn');
        const statusMessage = document.getElementById('status-message');
        const outputAudio = document.getElementById('output-audio');
        const masterVolume = document.getElementById('master-volume');
        const volumeValue = document.getElementById('volume-value');
        const reverbAmount = document.getElementById('reverb-amount');
        const reverbValue = document.getElementById('reverb-value');
        const musicLength = document.getElementById('music-length');
        const canvasElement = document.getElementById('canvas-visualizer');
        
        // Initialize canvas
        canvasVisualizer = document.getElementById('canvas-visualizer');
        canvasContext = canvasVisualizer.getContext('2d');
        
        // Set canvas size
        function resizeCanvas() {
            canvasVisualizer.width = canvasVisualizer.parentElement.clientWidth;
            canvasVisualizer.height = canvasVisualizer.parentElement.clientHeight;
        }
        
        // Call on load and resize
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Set up instrument selection
        const instrumentOptions = document.querySelectorAll('.instrument-option');
        instrumentOptions.forEach(option => {
            option.addEventListener('click', () => {
                option.classList.toggle('selected');
            });
        });
        
        // Update volume display
        masterVolume.addEventListener('input', () => {
            volumeValue.textContent = `${Math.round(masterVolume.value * 100)}%`;
        });
        
        // Update reverb display
        reverbAmount.addEventListener('input', () => {
            reverbValue.textContent = `${Math.round(reverbAmount.value * 100)}%`;
        });
        
        // Preload samples for realistic instruments
        const players = {
            oud: null,
            ney: null,
            qanun: null,
            daf: null,
            ambient: null,
            nature: null
        };

        // Add instrument colors after the players object
        const instrumentColors = {
            oud: '#e6935b',     // Orange
            ney: '#91c4e6',     // Light blue
            qanun: '#e6cc5b',   // Yellow
            daf: '#bd91e6',     // Purple
            ambient: '#5be6a3', // Mint green
            nature: '#7ab55b'   // Forest green
        };

        // Apply presets
        const presetButtons = document.querySelectorAll('.preset-btn');
        presetButtons.forEach(button => {
            button.addEventListener('click', () => {
                const preset = button.dataset.preset;
                applyPreset(preset);
            });
        });

        function applyPreset(preset) {
            // Reset selections
            instrumentOptions.forEach(option => {
                option.classList.remove('selected');
            });
            
            // Apply preset-specific settings
            switch(preset) {
                case 'meditation':
                    selectInstruments(['oud', 'ney', 'ambient', 'nature']);
                    masterVolume.value = 0.7;
                    reverbAmount.value = 0.6;
                    musicLength.value = '180';
                    break;
                case 'relaxation':
                    selectInstruments(['oud', 'ney', 'qanun', 'nature']);
                    masterVolume.value = 0.6;
                    reverbAmount.value = 0.4;
                    musicLength.value = '120';
                    break;
                case 'uplifting':
                    selectInstruments(['oud', 'qanun', 'daf']);
                    masterVolume.value = 0.8;
                    reverbAmount.value = 0.3;
                    musicLength.value = '90';
                    break;
            }
            
            // Update UI displays
            volumeValue.textContent = `${Math.round(masterVolume.value * 100)}%`;
            reverbValue.textContent = `${Math.round(reverbAmount.value * 100)}%`;
            
            statusMessage.textContent = `Applied ${preset} preset. Ready to generate.`;
        }
        
        function selectInstruments(instruments) {
            instrumentOptions.forEach(option => {
                if (instruments.includes(option.dataset.instrument)) {
                    option.classList.add('selected');
                }
            });
        }
        
        // Add this to the beginning of the script to handle Tone.js initialization
        window.addEventListener('load', async function() {
            // Try to initialize Tone.js on page load
            try {
                // Check if audio context is available
                if (typeof AudioContext === 'undefined' && typeof webkitAudioContext === 'undefined') {
                    console.error("Web Audio API is not supported in this browser");
                    statusMessage.textContent = "Your browser doesn't support Web Audio API. Please try a different browser.";
                    return;
                }
                
                // Check if Tone.js loaded
                if (!window.Tone) {
                    console.error("Tone.js failed to load");
                    statusMessage.textContent = "Tone.js failed to load. Check your internet connection.";
                    return;
                }
                
                console.log("Tone.js version:", Tone.version);
                statusMessage.textContent = "Click anywhere to initialize audio, then click 'Generate Music' to begin.";
                
                // Initialize UI elements
                resizeCanvas();
                
                // Single click handler for audio initialization
                const initAudio = async () => {
                    try {
                        await Tone.start();
                        await Tone.context.resume();
                        console.log("Audio context initialized:", Tone.context.state);
                        document.body.removeEventListener('click', initAudio);
                        statusMessage.textContent = "Audio initialized. Click 'Generate Music' to begin.";
                    } catch (error) {
                        console.error("Error initializing audio context:", error);
                    }
                };
                
                // Add click handler for audio initialization
                document.body.addEventListener('click', initAudio);
                
                // Set up button handlers
                generateBtn.addEventListener('click', async () => {
                    if (isPlaying) {
                        stopMusic();
                    } else {
                        await generateIslamicMusic();
                    }
                });
                
                stopBtn.addEventListener('click', stopMusic);
                exportBtn.addEventListener('click', exportGeneratedAudio);
                
                initializeEqualizer();
                initializeOtherMusic();
                
            } catch (error) {
                console.error("Error in initialization:", error);
                statusMessage.textContent = "Error initializing audio system. See console for details.";
            }
        });
        
        // Update the drawVisualization function
        function drawVisualization() {
            if (!analyser) return;
            
            // Clear the canvas with a slight fade effect
            canvasContext.fillStyle = 'rgba(249, 247, 242, 0.1)';
            canvasContext.fillRect(0, 0, canvasVisualizer.width, canvasVisualizer.height);
            
            // Calculate height for each instrument's section
            const activeInstruments = Object.keys(players).filter(key => players[key] !== null);
            const sectionHeight = canvasVisualizer.height / (activeInstruments.length || 1);
            
            // Draw each active instrument's waveform
            activeInstruments.forEach((instrument, index) => {
                const player = players[instrument];
                if (!player) return;
                
                // Create analyzer for this instrument if it doesn't exist
                if (!player.analyzer) {
                    player.analyzer = Tone.context.createAnalyser();
                    player.analyzer.fftSize = 2048;
                    player.analyzer.smoothingTimeConstant = 0.8;
                    player.connect(player.analyzer);
                }
                
                const dataArray = new Uint8Array(player.analyzer.frequencyBinCount);
                player.analyzer.getByteTimeDomainData(dataArray);
                
                // Draw instrument name
                canvasContext.fillStyle = instrumentColors[instrument];
                canvasContext.font = '14px Arial';
                canvasContext.fillText(instrument.toUpperCase(), 10, index * sectionHeight + 20);
                
                // Draw waveform
                canvasContext.lineWidth = 2;
                canvasContext.strokeStyle = instrumentColors[instrument];
                canvasContext.beginPath();
                
                const sliceWidth = canvasVisualizer.width / dataArray.length;
                let x = 0;
                
                for (let i = 0; i < dataArray.length; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (v * sectionHeight / 2) + (index * sectionHeight) + (sectionHeight / 2);
                    
                    if (i === 0) {
                        canvasContext.moveTo(x, y);
                    } else {
                        canvasContext.lineTo(x, y);
                    }
                    
                    x += sliceWidth;
                }
                
                canvasContext.lineTo(canvasVisualizer.width, index * sectionHeight + sectionHeight / 2);
                canvasContext.stroke();
                
                // Draw separator line
                canvasContext.strokeStyle = 'rgba(33, 123, 119, 0.2)';
                canvasContext.lineWidth = 1;
                canvasContext.beginPath();
                canvasContext.moveTo(0, (index + 1) * sectionHeight);
                canvasContext.lineTo(canvasVisualizer.width, (index + 1) * sectionHeight);
                canvasContext.stroke();
            });
            
            animationFrame = requestAnimationFrame(drawVisualization);
        }
        
        async function generateIslamicMusic() {
            try {
                // Ensure audio context is started
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    await Tone.context.resume();
                    console.log("Audio context started and resumed:", Tone.context.state);
                }

                // Get selected instruments
                const selectedInstruments = [];
                instrumentOptions.forEach(option => {
                    if (option.classList.contains('selected')) {
                        selectedInstruments.push(option.dataset.instrument);
                    }
                });
                
                if (selectedInstruments.length === 0) {
                    alert("Please select at least one instrument");
                    return;
                }
                
                const duration = parseInt(musicLength.value);
                const volume = parseFloat(masterVolume.value);
                const reverb = parseFloat(reverbAmount.value);
                
                // Create audio chain
                const masterGain = new Tone.Gain(volume);
                
                // Create the effects chain: source -> EQ -> reverb -> master
                const reverbEffect = new Tone.Reverb({
                    decay: 2,
                    wet: reverb
                });
                
                // Connect the chain
                masterGain.connect(window.masterEQ);  // Connect to EQ first
                window.masterEQ.connect(reverbEffect);  // EQ to reverb
                reverbEffect.connect(Tone.Destination);  // Reverb to master output
                
                // Set up analyser after the entire chain
                analyser = Tone.context.createAnalyser();
                analyser.fftSize = 2048;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                reverbEffect.connect(analyser);
                
                // Start recorder
                recorder = new Tone.Recorder();
                reverbEffect.connect(recorder);
                
                // Get local paths to audio files
                const audioPaths = {
                    oud: "assets/audio/meditative-oud-palestinian-soul-112719.mp3",
                    ney: "assets/audio/flute-melody-315241.mp3",
                    qanun: "assets/audio/turkish-classical-277435.mp3",
                    daf: "assets/audio/impro-binaire-140-78486.mp3",
                    ambient: "assets/audio/ambient-relaxing-music-for-you-15969.mp3",
                    nature: "assets/audio/nature-walk-124997.mp3"
                };
                
                // Update UI first
                generateBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Music';
                statusMessage.textContent = "Loading audio files...";
                stopBtn.disabled = false;
                exportBtn.disabled = true;
                isPlaying = true;
                
                // Start visualization
                drawVisualization();
                
                // Start recording
                recorder.start();
                
                // Load and connect selected instruments
                statusMessage.textContent = "Loading instruments...";
                console.log("Loading selected instruments:", selectedInstruments);
                
                // Clear any existing players
                for (const instrument in players) {
                    if (players[instrument]) {
                        players[instrument].dispose();
                        players[instrument] = null;
                    }
                }
                
                // Create promises for all players to load
                const playerPromises = [];
                
                for (const instrument of selectedInstruments) {
                    console.log(`Loading ${instrument} from ${audioPaths[instrument]}`);
                    
                    const playerPromise = new Promise((resolve, reject) => {
                        try {
                            const player = new Tone.Player({
                                url: audioPaths[instrument],
                                loop: true,
                                volume: -6,
                                onload: () => {
                                    statusMessage.textContent = `Loaded ${instrument}...`;
                                    console.log(`Successfully loaded ${instrument}`);
                                    
                                    // Create analyzer for this instrument
                                    player.analyzer = Tone.context.createAnalyser();
                                    player.analyzer.fftSize = 2048;
                                    player.analyzer.smoothingTimeConstant = 0.8;
                                    
                                    // Connect through the chain
                                    player.connect(player.analyzer);
                                    player.connect(masterGain);
                                    
                                    resolve();
                                },
                                onerror: (e) => {
                                    console.error(`Error loading ${instrument}:`, e);
                                    statusMessage.textContent = `Error loading ${instrument}. Check console.`;
                                    reject(e);
                                }
                            }).connect(reverbEffect);
                            
                            players[instrument] = player;
                        } catch (error) {
                            console.error(`Error creating player for ${instrument}:`, error);
                            reject(error);
                        }
                    });
                    
                    playerPromises.push(playerPromise);
                }
                
                try {
                    // Wait for all players to load
                    await Promise.all(playerPromises);
                    
                    statusMessage.textContent = "Starting playback...";
                    console.log("All instruments loaded, starting playback");
                    
                    // Start all players
                    for (const instrument in players) {
                        if (players[instrument]) {
                            console.log(`Starting ${instrument} playback`);
                            players[instrument].start();
                        }
                    }
                    
                    statusMessage.textContent = "Playing Islamic ambience...";
                    
                    // Schedule end of recording after duration
                    setTimeout(async () => {
                        if (isPlaying) {
                            try {
                                console.log("Stopping recording");
                                const recording = await recorder.stop();
                                console.log("Recording completed");
                                outputAudio.src = URL.createObjectURL(recording);
                                outputAudio.style.display = "block";
                                playerBuffer = recording;
                                exportBtn.disabled = false;
                                
                                statusMessage.textContent = "Music generation complete. You can now play, export, or generate a new piece.";
                            } catch (error) {
                                console.error("Error stopping recorder:", error);
                                statusMessage.textContent = "Error creating recording. See console for details.";
                            }
                        }
                    }, duration * 1000);
                    
                } catch (error) {
                    console.error("Error loading instruments:", error);
                    statusMessage.textContent = "Error loading instruments. Check console for details.";
                    stopMusic();
                }
            } catch (error) {
                console.error("Error in generateIslamicMusic:", error);
                statusMessage.textContent = "Error generating music. See console for details.";
                stopMusic();
            }
        }
        
        function stopMusic() {
            // Stop all players
            for (const instrument in players) {
                if (players[instrument]) {
                    players[instrument].stop();
                    players[instrument].dispose();
                    players[instrument] = null;
                }
            }
            
            // Stop transport and cancel animation
            Tone.Transport.stop();
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            // Reset UI
            generateBtn.innerHTML = '<i class="fas fa-play"></i> Generate Music';
            stopBtn.disabled = true;
            isPlaying = false;
            statusMessage.textContent = "Music stopped. Ready to generate again.";
        }
        
        function exportGeneratedAudio() {
            if (!playerBuffer) {
                alert("Generate music first");
                return;
            }
            
            const a = document.createElement("a");
            a.href = URL.createObjectURL(playerBuffer);
            a.download = "islamic-ambience.wav";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            statusMessage.textContent = "Audio exported successfully!";
        }

        function initializeEqualizer() {
            // Create a single EQ3 instance instead of three separate ones
            const eq = new Tone.EQ3({
                low: 0,
                mid: 0,
                high: 0,
                lowFrequency: 100,
                highFrequency: 10000
            });
            
            // Connect EQ to master output
            eq.toDestination();
            
            // Store the EQ instance globally
            window.masterEQ = eq;
            
            // Add event listeners for EQ controls with immediate feedback
            document.getElementById('eq-low').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value);
                eq.low.value = value;
                document.getElementById('eq-low-value').textContent = value + ' dB';
            });
            
            document.getElementById('eq-mid').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value);
                eq.mid.value = value;
                document.getElementById('eq-mid-value').textContent = value + ' dB';
            });
            
            document.getElementById('eq-high').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value);
                eq.high.value = value;
                document.getElementById('eq-high-value').textContent = value + ' dB';
            });
            
            return eq;
        }

        function initializeOtherMusic() {
            // Set up tab switching
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and panes
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding pane
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                    
                    // Load asset browser content if needed
                    if (button.dataset.tab === 'asset-browser') {
                        loadAssetBrowser();
                    }
                });
            });
            
            // Initial load of asset browser
            loadAssetBrowser();
        }

        async function loadAssetBrowser() {
            const assetList = document.querySelector('.asset-browser-list');
            
            try {
                // Get the list of MP3 files from assets/audio
                const audioFiles = [
                    'meditative-oud-palestinian-soul-112719.mp3',
                    'flute-melody-315241.mp3',
                    'turkish-classical-277435.mp3',
                    'impro-binaire-140-78486.mp3',
                    'ambient-relaxing-music-for-you-15969.mp3',
                    'nature-walk-124997.mp3',
                    'nature-calls-136344.mp3',
                    'documentary-nature-ambient-313048.mp3',
                    'nature-documentary-309042.mp3',
                    'melody-of-nature-main-6672.mp3',
                    'islamic-background-music-no-copyright-279031.mp3',
                    'haunting-middle-eastern-piece-188714.mp3',
                    'islamic-background-music-no-copyright-1-279030.mp3',
                    'the-voice-of-the-oud-258611.mp3'
                ];
                
                // Create HTML for each audio file
                const audioListHTML = audioFiles.map(file => `
                    <div class="track-item">
                        <span class="track-name">${file}</span>
                        <div class="track-controls">
                            <button onclick="previewTrack('${file}')" class="btn-generate">
                                <i class="fas fa-play"></i>
                            </button>
                            <button onclick="addToCustomTracks('${file}')" class="btn-export">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                assetList.innerHTML = audioListHTML;
            } catch (error) {
                console.error('Error loading asset browser:', error);
                assetList.innerHTML = '<p>Error loading audio files. Please try again.</p>';
            }
        }

        async function previewTrack(filename) {
            try {
                const player = new Tone.Player({
                    url: `assets/audio/${filename}`,
                    autostart: true,
                    onload: () => {
                        console.log(`Preview playing: ${filename}`);
                    },
                    onerror: (e) => {
                        console.error(`Error previewing ${filename}:`, e);
                        alert(`Error playing ${filename}`);
                    }
                }).toDestination();
                
                // Stop after 5 seconds preview
                setTimeout(() => {
                    player.stop();
                    player.dispose();
                }, 5000);
            } catch (error) {
                console.error('Error previewing track:', error);
            }
        }

        function addToCustomTracks(filename) {
            const trackId = Date.now().toString();
            customTracks.set(trackId, {
                filename,
                player: null,
                volume: 0.8
            });
            
            updateCustomTracksList();
        }

        function updateCustomTracksList() {
            const customTracksList = document.querySelector('.custom-tracks-list');
            
            const tracksHTML = Array.from(customTracks.entries()).map(([id, track]) => `
                <div class="track-item" data-track-id="${id}">
                    <span class="track-name">${track.filename}</span>
                    <div class="track-controls">
                        <input type="range" 
                               min="0" 
                               max="1" 
                               step="0.1" 
                               value="${track.volume}"
                               onchange="updateTrackVolume('${id}', this.value)">
                        <button onclick="removeCustomTrack('${id}')" class="btn-stop">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            customTracksList.innerHTML = tracksHTML || '<p>No custom tracks added yet.</p>';
        }

        function updateTrackVolume(trackId, volume) {
            const track = customTracks.get(trackId);
            if (track) {
                track.volume = parseFloat(volume);
                if (track.player) {
                    track.player.volume.value = track.volume;
                }
            }
        }

        function removeCustomTrack(trackId) {
            const track = customTracks.get(trackId);
            if (track && track.player) {
                track.player.stop();
                track.player.dispose();
            }
            customTracks.delete(trackId);
            updateCustomTracksList();
        }

        // Modify your existing generateIslamicMusic function to include custom tracks
        const originalGenerateIslamicMusic = generateIslamicMusic;
        generateIslamicMusic = async function() {
            try {
                await originalGenerateIslamicMusic();
                
                // Add custom tracks to the mix
                for (const [id, track] of customTracks.entries()) {
                    if (!track.player) {
                        track.player = new Tone.Player({
                            url: `assets/audio/${track.filename}`,
                            loop: true,
                            volume: track.volume,
                            onload: () => {
                                console.log(`Loaded custom track: ${track.filename}`);
                                track.player.start();
                            }
                        }).connect(window.masterEQ);
                    }
                }
            } catch (error) {
                console.error('Error in modified generateIslamicMusic:', error);
            }
        };
    </script>
</body>
</html> 